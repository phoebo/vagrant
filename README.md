# Vagrant for Phoebo CI

This is installation package for Phoebo CI development and testing with your own Gitlab.
It simulates Phoebo CI infrastructure on 2 separate VMs.

**The Master node** is running Phoebo CI server, nginx proxy and Mesos Master + Singularity.

**The Slave node** is running Mesos Slave which automatically pairs itself with Master node.

Vagrant is developed for [Parallels provider](http://parallels.github.io/vagrant-parallels/docs/).
It might need slight modification to run on other providers. At least you will need to change the
base box image. The installation is done on top of Ubuntu Server 14.04 LTS (Trusty Tahr) 64-bit.
Suitable image for Virtualbox might be `ubuntu/trusty64`.

You will need at least 2.5 GB RAM available.

## Installation

Previous experience with Vagrant is highly recommended. Please get yourself familiar with the environment first by reading [Vagrant: Getting started](http://docs.vagrantup.com/v2/getting-started/index.html).

**All instructions bellow expect that current working directory is a root directory of this project.**

```bash
# Install vagrant-hostmanager for managing DN <-> IP translations
# on guest and host systems
vagrant plugin install vagrant-hostmanager

# Start master node
# Will ask for password for setting of hosts file.
vagrant up master

# Start slave node
# Will ask for password for setting of hosts file.
vagrant up slave1

# If you need to refresh hosts
# Will ask for password for setting of hosts file.
vagrant hostmanager
```

**Note:** Vagrant will download huge amount of files while being provisioned.
It is possible that you will encounter some timeouts. If such error occurs
you cant restart the provisioning step anytime by `vagrant provision master`
(or `vagrant provision slave1`).

**Warning:** There seems to be bug in `vagrant-hostmanager` causing inability to enter
password when both nodes are being set up at the same time (by `vagrant up`). You can bypass
this by starting them individually as shown in the example.

## Usage

Source files to Phoebo CI are stored at `Data/Phoebo` on host machine. They are shared using Vagrant shared folders. Any changes to files in `Data/Phoebo/app` are automatically applied to running instance. If you modify any other file you might need to restart the application server. You may do so by running `sudo restart phoebo` on master node. Or by `vagrant ssh master -c 'sudo restart phoebo'` from the host.

### Configuration

Once you have your vagrant nodes up and running, the first thing you need to do is **set up the application configuration to match your Gitlab server.**

You can do so by editing the configuration at `Data/Phoebo/config/application.yml` on your host machine.
For help please refer to [Configuration section of Phoebo CI](https://github.com/phoebo/phoebo/blob/master/README.md#configuration).

**Don't forget to add the Phoebo CI into authorized applications in your Gitlab server. ([See how](https://github.com/phoebo/phoebo/blob/master/README.md#gitlab-server-configuration))**

After the configuration is changeed you need to restart Phoebo CI by running `sudo restart phoebo` on the master node.

Once it is restarted you are ready to use the application.

### Host setup

Vagrant will automatically set up hosts for basic services depending on the configuration in `Vagrantfile`.
Default is to publish services on:

- <http://phoebo.local> for Phoebo CI
- <http://singularity.phoebo.local> for Singularity UI
- <http://phoebo.local:5050> for Mesos UI
- <http://slave1.phoebo.local:5051> for Mesos Slave API

You will, however, need to setup host translation for your published apps on the CI.

The URIs are build by pattern `<8-char-long-build-ref>.<task-name>-<gitlab-project-id>.<master-node-fqdn>`.

For example for accessing web service of task `web` of Gitlab project with ID `13` at commit `1127217cfc2ee790c560ad080f8694136548c46b` you will need to address `1127217c.web-9.phoebo.local` to IP address of the master node.

You can do so by editing hosts file (ie. /etc/hosts) on your system or by setting them up in `Vagrantfile`.

### Some important files

- **On host:**

	- `Data/Phoebo/config/application.yml`
	  Application configuration. Automatically generated by Vagrant to suit testing setup.
	  **You need to change the connection info to your Gitlab server.**
	  <br>
	- `Data/Phoebo/config/initializers/00_vagrant.rb`
	  Special initializer for Vagrant deployment. It takes care for IP translation of slave node. (Vagrant does not come with own DNS server).
	  <br>
	- `Data/Phoebo/config/database.yml`
	  Connection settings for local database server. It is automatically set up by Vagrant.
	  <br>

- **On Master node:**

	- `/var/log/upstart/phoebo.log`
	  Log of Phoebo CI application server.
	  <br>
	- `/var/log/singularity/singularity.log`
	  Log of Singularity server.
	  <br>
	- `/var/log/upstart/nginx.log`
	  Log of nginx proxy daemon


### Some important commands

- **Master node:**

	- `sudo restart phoebo`
	- `sudo restart nginx`
	- `sudo restart mesos-master`
	- `sudo restart singularity`

- **Slave node:**

	- `sudo restart mesos-slave`

## Troubleshooting

### 502 Bad Gateway error while accessing the service

It means that underlaying service is not responding. Restart your Phoebo CI or Singularity (depending on which service are you trying to access).

Check logs for errors and report them if problem persists.

### Singularity keeps crashing on start.

Project currently uses Singularity 0.4.1. It is far from stable yet.
If you get it to bad state and it keeps quiting on start it is necessary to remove invalid data in zookeeper.

You can use bundled `zkCli.sh` script on your Master node.

```
/usr/share/zookeeper/bin/zkCli.sh
[zk: localhost:2181(CONNECTED) 0] rmr /singularity
[zk: localhost:2181(CONNECTED) 0] quit
```

### Shared folder issues

Running project in shared-folder from host system may cause some issues (failed chown etc.) depending on Vagrant provider and the platform you are using. This is not generally a Phoebo CI issue. You might want to try switching to sharing over NFS or dont use shared folder at all. Shared folders are used only to keep development easy. You may run Phoebo CI solely from the guest. All you need to do is change project directory in `/etc/upstart/phoebo.conf` to match your location on the guest file system.

## Contact

Project is developed by Adam StanÄ›k <adam.stanek@v3net.cz>
